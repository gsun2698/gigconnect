---
import type { Artist } from "../types/Artists";

interface Props {
  artist: Artist;
  assignments?: Record<string, { stage: string; time: string }>;
}

const { artist, assignments = {} } = Astro.props as Props;
---

<article class="group w-full max-w-xs bg-slate-800 rounded-xl border border-slate-700 overflow-hidden flex flex-col">
  <div class="relative h-40 overflow-hidden bg-slate-900">
    {artist.image && (
      <>
        <img src={artist.image} alt="" class="absolute inset-0 w-full h-full object-cover blur-md scale-110 opacity-40" />
        <img src={artist.image} alt={artist.name} class="absolute inset-0 w-full h-full object-contain p-3" loading="lazy" />
      </>
    )}
    <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/50 to-transparent"></div>
    <div class="absolute bottom-0 left-0 right-0 p-3">
      <h2 class="text-base font-semibold text-slate-100 drop-shadow-md">{artist.name}</h2>
    </div>
  </div>

  <div class="p-4 flex flex-col gap-1">
    <p class="text-xs text-slate-300">{artist.genre} Â· {artist.location}</p>
    <p class="text-xs text-slate-300">Rate: {artist.rateTier}</p>

    <a href={`/artists/${artist.slug}`} class="mt-3 inline-block bg-indigo-600 hover:bg-indigo-400 text-white px-3 py-1 rounded-lg text-xs text-center font-medium">
      View details
    </a>

    <button
      class="planner-toggle mt-2 px-3 py-1 rounded-lg text-xs font-medium cursor-pointer transition font-bold"
      data-slug={artist.slug}
      type="button"
    >
      Add to Planner
    </button>
  </div>
</article>

<script type="module" client:load>
const STORAGE_KEY = "gigconnect-shortlist";

function getShortlist() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } 
  catch { return []; }
}

function saveShortlist(list) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}

function updateButton(btn, assignments) {
  const slug = btn.dataset.slug;
  const shortlist = getShortlist();
  const assigned = assignments && assignments[slug]; // check if artist is on a stage
  const inPlanner = shortlist.includes(slug);

  if (assigned) {
    btn.textContent = "Assigned to Stage";
    btn.disabled = true;
    btn.classList.remove("bg-indigo-600", "hover:bg-indigo-500", "bg-red-600", "hover:bg-red-500");
    btn.classList.add("bg-gray-500", "cursor-not-allowed");
  } else {
    btn.disabled = false;
    btn.textContent = inPlanner ? "Remove from Planner" : "Add to Planner";
    btn.classList.remove("bg-gray-500", "cursor-not-allowed", "bg-red-600", "hover:bg-red-500", "bg-indigo-600", "hover:bg-indigo-500");
    btn.classList.add(inPlanner ? "bg-red-600" : "bg-indigo-600");
    btn.classList.add(inPlanner ? "hover:bg-red-500" : "hover:bg-indigo-500");
  }
}

function attachPlannerButtons(assignments) {
  document.querySelectorAll(".planner-toggle").forEach(btn => {
    const newBtn = btn.cloneNode(true);
    btn.replaceWith(newBtn);

    updateButton(newBtn, assignments);

    newBtn.addEventListener("click", () => {
      if (newBtn.disabled) return;

      const slug = newBtn.dataset.slug;
      let shortlist = getShortlist();
      if (shortlist.includes(slug)) shortlist = shortlist.filter(s => s !== slug);
      else shortlist.push(slug);
      saveShortlist(shortlist);

      updateButton(newBtn, assignments);
      window.dispatchEvent(new Event("shortlistUpdated"));
    });
  });
}

// Fetch assignments from localStorage
function getAssignments() {
  try { return JSON.parse(localStorage.getItem("gigconnect-stage-assignments")) || {}; }
  catch { return {}; }
}

// Initial setup
attachPlannerButtons(getAssignments());

// Update buttons when shortlist changes elsewhere
window.addEventListener("shortlistUpdated", () => attachPlannerButtons(getAssignments()));
</script>
