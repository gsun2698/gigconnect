---
import BaseLayout from "../layouts/BaseLayout.astro";
import artistsData from "../data/artists.json";
---

<BaseLayout title="GigConnect - Planner">

  <!-- Page Header Section -->
  <section 
    class="relative mb-15 py-5 px-6 rounded-2xl 
           bg-gradient-to-br from-purple-900/70 via-slate-900 to-purple-900/60 
           border border-purple-500/30
           shadow-[0_0_0_1.5px_rgba(168,85,247,0.45), 0_10px_30px_-10px_rgba(0,0,0,0.6)]">
    
    <!-- Decorative gradient line -->
    <div 
      class="absolute top-0 left-8 right-8 h-px
             bg-gradient-to-r from-transparent via-purple-400/70 to-transparent">
    </div>

    <!-- Main title -->
    <h1 class="inline-block text-3xl md:text-4xl font-extrabold text-white mb-6 pb-2 border-b border-gray-500 tracking-tight">
      Planner
    </h1>

    <!-- Description -->
    <p class="text-slate-300 max-w-2xl font-bold text-xl">
      Review and organize your shortlisted artists. Select artists to assign them to stages and time slots for your event.
    </p>
  </section>

  <!-- Status message -->
  <p id="planner-status" class="text-slate-300 text-sm mb-6"></p>

  <!-- Artist Pool: shows artists currently in the shortlist -->
  <div
    id="planner-grid"
    class="grid gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4"
  ></div>

  <!-- Stages Section -->
  <section class="max-w-full mx-auto px-6 mt-12">
    <h2 class="text-3xl font-bold mb-12">Stages</h2>

    <!-- Container for all stages -->
    <div
      id="stages-board"
      class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"
    ></div>

    <!-- Single Remove All Artists Button -->
    <div class="mt-6">
      <button
        id="remove-all-artists"
        class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg cursor-pointer font-medium"
      >
        Remove All Artists
      </button>
    </div>
  </section>

  <div class="mt-8 mb-6 border-t border-slate-600/40"></div>
  
  <!-- Actions: clear shortlist, save, download -->
  <div class="mt-15 flex gap-3">
    <button
      id="clear-shortlist"
      class="bg-slate-700 hover:bg-red-600 cursor-pointer px-4 py-2 rounded-lg text-sm font-medium"
    >
      Clear Shortlist
    </button>
    <button
      id="download-lineup"
      class="bg-indigo-500 hover:bg-indigo-300 px-4 py-2 rounded-lg text-sm font-bold transition transform cursor-not-allowed"
      title="Downloading not available in demo"
    >Download Lineup</button>
    <button
      id="save-lineup"
      class="bg-indigo-700 hover:bg-indigo-500 cursor-not-allowed px-4 py-2 rounded-lg text-sm font-bold transition"
      title="Saving not available in demo"
    >Save Lineup</button>
  </div>

  <!-- Time Selection Modal -->
  <div
    id="time-modal"
    class="fixed inset-0 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300"
  >
    <!-- Background overlay -->
    <div id="modal-overlay" class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm"></div>

    <!-- Modal content -->
    <div class="relative bg-slate-900 p-6 rounded-xl w-[420px] max-w-full z-10 shadow-xl">
      <h3 class="text-white font-semibold mb-4 text-center">Select a Time</h3>
      <div
        id="time-buttons"
        class="space-y-5 space-x-20 max-h-96 overflow-y-auto"
      ></div>
      <button
        id="close-modal"
        class="mt-4 w-full bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded-lg cursor-pointer"
      >
        Cancel
      </button>
    </div>
  </div>

  <!-- Pass artists data from server to client -->
  <script
    id="artists-data"
    type="application/json"
    set:html={JSON.stringify(artistsData)}
  ></script>

  <!-- Client-side Planner Script -->
  <script type="module">
    // Load all artists
    const allArtists = JSON.parse(document.getElementById("artists-data").textContent);

    // Define stages/venues
    const venues = [
      { stageId: "nova-prime", name: "Nova Prime" },
      { stageId: "pulse-arena", name: "Pulse Arena" },
      { stageId: "lunar-hall", name: "Lunar Hall" },
      { stageId: "nova-second", name: "Nova Second" }
    ];

    // Keys for localStorage
    const STORAGE_KEY = "gigconnect-shortlist";
    const STAGE_KEY = "gigconnect-stage-assignments";

    // DOM Elements
    const gridEl = document.getElementById("planner-grid");
    const stageBoard = document.getElementById("stages-board");
    const clearBtn = document.getElementById("clear-shortlist");
    const removeAllBtn = document.getElementById("remove-all-artists");

    const modal = document.getElementById("time-modal");
    const timeButtons = document.getElementById("time-buttons");
    const closeModalBtn = document.getElementById("close-modal");
    const overlay = document.getElementById("modal-overlay");

    let selectedArtistSlug = null;
    let selectedStageId = null;

    // LocalStorage helpers
    const getShortlist = () => JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    const saveShortlist = list => localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    const getAssignments = () => JSON.parse(localStorage.getItem(STAGE_KEY)) || {};
    const saveAssignments = data => localStorage.setItem(STAGE_KEY, JSON.stringify(data));

    // Convert time string to minutes for sorting
    function timeToMinutes(time) {
      const [hm, period] = time.split(" ");
      let [hour, minute] = hm.split(":").map(Number);
      if (period === "PM" && hour !== 12) hour += 12;
      if (period === "AM" && hour === 12) hour = 0;
      return hour * 60 + minute;
    }

    // Generate 15-minute time slots between 1PM-11PM
    function generateTimeSlots() {
      const slots = [];
      let hour = 13;
      let minute = 0;
      while (hour < 23 || (hour === 23 && minute === 0)) {
        const displayHour = hour % 12 || 12;
        const displayMinute = minute.toString().padStart(2, "0");
        slots.push(`${displayHour}:${displayMinute} PM`);
        minute += 15;
        if (minute === 60) {
          minute = 0;
          hour++;
        }
      }
      return slots;
    }

    // Get used times for a stage to prevent overlaps
    function getUsedTimes(stageId) {
      const assignments = getAssignments();
      return Object.values(assignments)
        .filter(a => a.stage === stageId)
        .map(a => a.time);
    }

    // Open time selection modal for assigning artist to stage
    function openTimeModal() {
      if (!selectedArtistSlug || !selectedStageId) return;

      timeButtons.innerHTML = "";
      const usedTimes = getUsedTimes(selectedStageId);
      let lastHour = null;

      generateTimeSlots().forEach(time => {
        const used = usedTimes.includes(time);
        const hour = time.split(":")[0];

        // Optional divider for new hour blocks
        if (hour !== lastHour) {
          const divider = document.createElement("div");
          divider.className = "col-span-3 border-t border-slate-700 my-1";
          timeButtons.appendChild(divider);
          lastHour = hour;
        }

        const btn = document.createElement("button");
        btn.textContent = time;
        btn.className =
          "px-2 py-1 rounded text-xs font-medium cursor-pointer " +
          (used
            ? "bg-slate-600 text-slate-300 cursor-not-allowed"
            : "bg-indigo-600 hover:bg-indigo-500 text-white");

        btn.disabled = used;

        if (!used) {
          btn.onclick = () => {
            // Assign artist to selected stage and time
            const assignments = getAssignments();
            assignments[selectedArtistSlug] = { stage: selectedStageId, time };
            saveAssignments(assignments);

            // Remove artist from shortlist after assignment
            const shortlist = getShortlist().filter(s => s !== selectedArtistSlug);
            saveShortlist(shortlist);

            closeTimeModal();
            selectedArtistSlug = null;
            render();
          };
        }

        timeButtons.appendChild(btn);
      });

      modal.classList.remove("opacity-0", "pointer-events-none");
    }

    function closeTimeModal() {
      modal.classList.add("opacity-0", "pointer-events-none");
      selectedStageId = null;
    }

    overlay.onclick = closeTimeModal;
    closeModalBtn.onclick = closeTimeModal;

    // Render artist pool (shortlisted artists not yet assigned)
    function renderPool() {
      const shortlist = getShortlist();
      const assignments = getAssignments();
      gridEl.innerHTML = "";

      const available = shortlist.filter(slug => !assignments[slug]);
      clearBtn.style.display = "inline-flex";

      available.forEach(slug => {
        const artist = allArtists.find(a => a.slug === slug);
        if (!artist) return;

        const card = document.createElement("article");
        card.className =
          "w-full bg-slate-800 border border-slate-700 rounded-xl p-5 flex justify-between items-center cursor-pointer";

        const info = document.createElement("div");
        info.innerHTML = `
          <p class="font-semibold text-sm">${artist.name}</p>
          <p class="text-xs text-slate-300">${artist.rateTier}</p>
        `;
        card.appendChild(info);

        const removeBtn = document.createElement("button");
        removeBtn.textContent = "✕";
        removeBtn.className = "ml-4 text-slate-400 font-bold text-lg";
        removeBtn.onclick = (e) => {
          e.stopPropagation();
          const shortlistUpdated = getShortlist().filter(s => s !== slug);
          saveShortlist(shortlistUpdated);
          render();
        };
        card.appendChild(removeBtn);

        if (selectedArtistSlug === slug) {
          card.classList.add("ring-2", "ring-indigo-400");
        }

        card.onclick = () => {
          selectedArtistSlug = slug;
          render();
        };

        gridEl.appendChild(card);
      });
    }

    // Render all stages with assigned artists
    function renderStages() {
      stageBoard.innerHTML = "";
      const assignments = getAssignments();

      venues.forEach(stage => {
        const stageEl = document.createElement("div");
        stageEl.className =
          "bg-slate-800 p-6 rounded-2xl min-h-[380px] shadow-lg flex flex-col";

        stageEl.innerHTML = `<h3 class="font-bold text-lg mb-4">${stage.name}</h3>`;

        const stageAssignments = Object.entries(assignments)
          .filter(([_, info]) => info.stage === stage.stageId)
          .sort((a, b) => timeToMinutes(a[1].time) - timeToMinutes(b[1].time));

        stageAssignments.forEach(([slug, info]) => {
          const artist = allArtists.find(a => a.slug === slug);
          if (!artist) return;

          const item = document.createElement("div");
          item.className =
            "bg-indigo-600 text-white px-4 py-3 rounded-lg mb-3 flex justify-between items-center text-sm";

          item.innerHTML = `<span>${artist.name} (${info.time})</span><button class="text-red-200">✕</button>`;

          // Remove from stage and return to shortlist
          item.querySelector("button").onclick = () => {
            const assignments = getAssignments();
            delete assignments[slug];
            saveAssignments(assignments);

            const shortlist = getShortlist();
            if (!shortlist.includes(slug)) shortlist.push(slug);
            saveShortlist(shortlist);

            render();
          };

          stageEl.appendChild(item);
        });

        // Highlight stage if an artist is selected and unassigned
        const isArtistSelectable =
          selectedArtistSlug && !assignments[selectedArtistSlug];

        if (isArtistSelectable) {
          stageEl.classList.add("ring-2", "ring-indigo-400", "cursor-pointer");
          stageEl.onclick = () => {
            selectedStageId = stage.stageId;
            openTimeModal();
          };
        }

        stageBoard.appendChild(stageEl);
      });
    }

    // Clear entire shortlist
    clearBtn.onclick = () => {
      saveShortlist([]);
      render();
    };

    // Remove all artists from all stages back to shortlist
    removeAllBtn.onclick = () => {
      const assignments = getAssignments();
      const shortlist = getShortlist();

      Object.keys(assignments).forEach(slug => {
        if (!shortlist.includes(slug)) shortlist.push(slug);
        delete assignments[slug];
      });

      saveAssignments(assignments);
      saveShortlist(shortlist);
      render();
    };

    // Main render function
    function render() {
      renderPool();
      renderStages();
    }

    render();
  </script>
</BaseLayout>
